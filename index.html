<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Previsão do Tempo Renato Stofel</title>
  <meta name="description" content="Mapa com imagens de satélite NASA, radar de chuva e previsão Open-Meteo" />
  <meta name="theme-color" content="#0b2a4a" />
  <style>
    :root{
      --bg:#0b1220; --ink:#e5ecf5; --muted:#9fb3c8; --card:#0f172a; --head:#111827;
      --accent:#38bdf8; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --hair:#ffffff22;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans';
         color:var(--ink); background:var(--bg); transition: background 1.5s ease}
    
    /* Backgrounds dinâmicos baseados no tempo */
    body.sunny{background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)}
    body.cloudy{background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%)}
    body.rainy{background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%)}
    body.night{background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%)}
    
    .app{display:grid; grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; min-height:100vh}
    
    header{padding:12px 15px; background:rgba(17, 24, 39, 0.85); border-bottom:1px solid var(--hair); 
           display:flex; flex-wrap: wrap; gap:10px; align-items:center; justify-content:space-between;
           backdrop-filter: blur(10px);}
    header .title{display:flex; gap:12px; align-items:center}
    header h1{font-size:18px; margin:0; font-weight:700}
    header .sub{font-size:13px; color:var(--muted)}
    
    .map-wrap{position:relative; height:65vh}
    #map{position:absolute; inset:0}
    
    .panel{display:grid; gap:12px; padding:12px; background:rgba(15, 23, 42, 0.85); backdrop-filter: blur(10px);}
    .cards{display:grid; grid-template-columns: 1fr; gap:12px}
    
    @media (min-width:980px){
      .app{grid-template-columns: 1.3fr 1fr; grid-template-rows: auto 1fr}
      .map-wrap{grid-column:1/2; grid-row:2/3; height:auto}
      .panel{grid-column:2/3; grid-row:2/3; overflow:auto; max-height: calc(100vh - 80px)}
      header{grid-column:1/-1}
      .cards{grid-template-columns: repeat(2, minmax(0,1fr))}
    }
    
    .card{background:rgba(15, 23, 42, 0.7); border:1px solid var(--hair); border-radius:14px; padding:12px; backdrop-filter: blur(5px);}
    .card h3{margin:0 0 8px 0; font-size:15px; color:var(--accent)}
    
    .kpis{display:grid; grid-template-columns: repeat(3,1fr); gap:10px}
    .kpi{background:rgba(11, 19, 40, 0.7); border:1px solid var(--hair); border-radius:12px; padding:10px; text-align:center}
    .kpi .v{font-size:20px; font-weight:700; margin-bottom:4px}
    .kpi .l{font-size:12px; color:var(--muted)}
    
    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    button, select, input[type="datetime-local"]{
      background:rgba(11, 19, 40, 0.7); color:var(--ink); border:1px solid var(--hair); border-radius:10px; padding:8px 12px; font-size:14px; cursor:pointer
    }
    button:hover, select:hover{outline:1px solid var(--accent); background:rgba(15, 26, 51, 0.8)}
    
    .small{font-size:12px; color:var(--muted)}
    footer{padding:10px 15px; border-top:1px solid var(--hair); background:rgba(11, 18, 32, 0.85); 
           font-size:12px; color:var(--muted); text-align:center; backdrop-filter: blur(10px);}
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    
    button.on{outline:1px solid var(--accent); border-color: var(--accent); background:rgba(15, 26, 51, 0.8)}
    #gpsStatus{margin-left:6px}

    /* === Uber-like blue dot (pulsing) === */
    .uber-dot{position:relative; width:16px; height:16px;}
    .uber-dot .core{position:absolute; inset:0; border-radius:50%; background:#3b82f6; box-shadow:0 0 0 2px #fff;}
    .uber-dot .pulse{position:absolute; inset:-6px; border-radius:50%; border:2px solid #60a5fa; opacity:0; animation:pulse 2s ease-out infinite}
    @keyframes pulse{ 0%{transform:scale(0.6); opacity:0.6} 70%{transform:scale(1.6); opacity:0} 100%{transform:scale(1.8); opacity:0} }

    /* Alert styles */
    .alert{padding:8px 10px; border-radius:8px; font-size:14px; transition:all 0.3s ease; margin-top:8px}
    .alert.ok{background:rgba(22, 163, 74, 0.2); border-left:4px solid var(--ok)}
    .alert.bad{background:rgba(239, 68, 68, 0.2); border-left:4px solid var(--bad)}
    .alert.warn{background:rgba(245, 158, 11, 0.2); border-left:4px solid var(--warn)}
    
    /* Loading indicator */
    .loading{display:inline-block; width:16px; height:16px; border:2px solid transparent; border-top:2px solid var(--accent); border-radius:50%; animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    /* Layer control */
    .layer-control {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid var(--hair);
      border-radius: 10px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      backdrop-filter: blur(5px);
    }
    
    .layer-control label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    
    .layer-control label:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .layer-control input[type="radio"] {
      margin: 0;
    }
    
    /* Current conditions */
    .current-conditions {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .temp {
      font-size: 24px;
      font-weight: 700;
    }
    
    .condition {
      font-size: 14px;
      color: var(--muted);
    }
    
    /* Humidity indicator */
    .humidity {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
      font-size: 13px;
      color: var(--muted);
    }
    
    .humidity-bar {
      flex-grow: 1;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .humidity-fill {
      height: 100%;
      background: #38bdf8;
      border-radius: 2px;
      transition: width 0.5s ease;
    }
    
    /* Responsive improvements for mobile */
    @media (max-width:768px){
      .app{grid-template-rows: auto 1fr auto}
      .map-wrap{height:55vh}
      .cards{grid-template-columns: 1fr}
      .toolbar{flex-direction:column; align-items:stretch}
      .toolbar > *{flex:1}
      header .title h1{font-size:16px}
      header .sub{font-size:12px}
      .kpis{grid-template-columns: repeat(3,1fr)}
      .kpi .v{font-size:18px}
      .kpi .l{font-size:11px}
      .layer-control {
        top: 5px;
        right: 5px;
        padding: 8px;
      }
    }
    
    @media (max-width:480px){
      .map-wrap{height:50vh}
      header{padding:10px 12px}
      .panel{padding:10px}
      .card{padding:10px}
      .kpis{grid-template-columns: 1fr; gap:8px}
      .kpi{padding:8px}
      .toolbar button, .toolbar select, .toolbar input[type="datetime-local"]{
        padding:8px 10px; font-size:13px
      }
      .temp { font-size: 20px; }
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="cloudy">
  <div class="app">
    <header>
      <div class="title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2a7 7 0 00-7 7v1.126A4 4 0 004 14a4 4 0 004 4h8a4 4 0 002-7.53V9a7 7 0 00-6-6.93z" stroke="currentColor" stroke-width="1.4"/>
          <path d="M7 18l-1.2 2M11 18l-1.2 2M15 18l-1.2 2M19 18l-1.2 2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
        </svg>
        <div>
          <h1>Previsão do Tempo Renato Stofel</h1>
          <div class="sub">Imagens de satélite NASA • Radar de chuva • Previsão Open-Meteo</div>
        </div>
      </div>
      <div class="toolbar">
        <button id="btnHere">📍 Minha localização</button>
        <button id="btnFollow">📡 Seguir GPS: OFF</button>
        <span id="gpsStatus" class="small"></span>
        <button id="btnZN">🗺️ Zona Norte RJ</button>
        <label class="small">Data/hora (UTC): <input id="timeIso" type="datetime-local" step="1800"></label>
        <button id="btnNow">🔄 Agora</button>
        <select id="opacitySel" title="Opacidade">
          <option value="0.7">Opacidade 70%</option>
          <option value="0.9">Opacidade 90%</option>
          <option value="1">Opacidade 100%</option>
          <option value="0.5">Opacidade 50%</option>
        </select>
      </div>
    </header>

    <div class="map-wrap">
      <div id="map"></div>
      <div class="layer-control">
        <label><input type="radio" name="layer" value="satellite" checked> 🌤️ Satélite (Nuvens NASA)</label>
        <label><input type="radio" name="layer" value="precipitation"> 🌧️ Radar de Chuva</label>
      </div>
    </div>

    <section class="panel">
      <div class="cards">
        <div class="card">
          <h3>🌡️ Condições Atuais</h3>
          <div class="current-conditions">
            <div class="temp" id="currentTemp">--°C</div>
            <div class="condition" id="currentCondition">Carregando...</div>
          </div>
          <div class="humidity">
            <span>Umidade:</span>
            <div class="humidity-bar">
              <div class="humidity-fill" id="humidityBar" style="width: 0%"></div>
            </div>
            <span id="humidityValue">--%</span>
          </div>
          <div class="kpis">
            <div class="kpi"><div class="v" id="kProb">--%</div><div class="l">Prob. de chuva</div></div>
            <div class="kpi"><div class="v" id="kRain">-- mm</div><div class="l">Chuva (1h)</div></div>
            <div class="kpi"><div class="v" id="kSum">-- mm</div><div class="l">Acumulado hoje</div></div>
          </div>
        </div>
        
        <div class="card" id="alertBox">
          <h3>⚠️ Alerta Rápido (próximas 3h)</h3>
          <div class="alert" id="alertMsg">Carregando condições meteorológicas...</div>
        </div>
        
        <div class="card" style="grid-column:1/-1">
          <h3>📊 Previsão para as Próximas 48h</h3>
          <canvas id="chart" height="140"></canvas>
        </div>
      </div>
      
      <div class="small" style="margin-top:10px; text-align:center">
        Dados de satélite: NASA GIBS • Previsão: <a href="https://open-meteo.com/" target="_blank" rel="noopener">Open-Meteo</a> • Mapa base: © OpenStreetMap
      </div>
    </section>

    <footer>
      Atualizado automaticamente • Use o modo "Seguir GPS" para acompanhar sua localização em tempo real
    </footer>
  </div>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    // ===== Utils =====
    const $ = (id) => document.getElementById(id);
    const btnHere = $('btnHere');
    const btnFollow = $('btnFollow');
    const gpsStatus = $('gpsStatus');
    const btnZN = $('btnZN');
    const timeInput = $('timeIso');
    const btnNow = $('btnNow');
    const opacitySel = $('opacitySel');
    const alertMsg = $('alertMsg');
    const layerControls = document.querySelectorAll('input[name="layer"]');
    const currentTemp = $('currentTemp');
    const currentCondition = $('currentCondition');
    const humidityValue = $('humidityValue');
    const humidityBar = $('humidityBar');

    // ===== Config =====
    const ZONA_NORTE = { lat: -22.86, lon: -43.28, zoom: 12 };
    let current = { lat: ZONA_NORTE.lat, lon: ZONA_NORTE.lon };
    let currentLayerType = 'satellite';

    // ===== Map (Leaflet) =====
    const map = L.map('map', { 
      zoomControl: true, 
      worldCopyJump: true,
      preferCanvas: true
    }).setView([current.lat, current.lon], ZONA_NORTE.zoom);
    
    // Adicionar camada base do OpenStreetMap
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
      maxZoom: 19, 
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    });
    
    // Camada de satélite da NASA GIBS (MODIS True Color)
    const nasaBase = 'https://gibs.earthdata.nasa.gov/wmts/epsg3857/best';
    const nasaLayer = 'MODIS_Terra_CorrectedReflectance_TrueColor';
    const nasaTime = new Date().toISOString().split('T')[0]; // Data atual
    const nasaUrl = `${nasaBase}/${nasaLayer}/default/${nasaTime}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`;
    
    const satelliteLayer = L.tileLayer(nasaUrl, {
      maxZoom: 9,
      attribution: 'Imagery &copy; NASA EOSDIS',
      opacity: 0.8,
      errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='
    });
    
    // Adicionar camada base por padrão
    satelliteLayer.addTo(map);

    // NASA GIBS IMERG (Chuva)
    const gibsBase = 'https://gibs.earthdata.nasa.gov/wmts/epsg3857/best';
    const gibsLayer = 'GPM_3IMERGHH_06_precipitationCal';
    const gibsTms = 'GoogleMapsCompatible_Level9';
    const gibsUrl = (iso) => `${gibsBase}/${gibsLayer}/default/${iso}/${gibsTms}/{z}/{y}/{x}.png`;

    const roundTo30UTC = (d) => { 
      const x = new Date(d); 
      x.setUTCMinutes(x.getUTCMinutes() - (x.getUTCMinutes() % 30), 0, 0); 
      return x; 
    };
    
    const toIsoZ = (d) => d.toISOString().replace(/\.\d{3}Z$/, 'Z');

    let timeNowUTC = roundTo30UTC(new Date());
    const setTimeInput = (d) => { 
      // Converter UTC para horário local sem alterar o tempo real
      const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
      timeInput.value = local.toISOString().slice(0, 16); 
    };
    setTimeInput(timeNowUTC);

    let currentOverlayLayer = null;
    
    function refreshLayer() {
      // Remover camada anterior se existir
      if (currentOverlayLayer) {
        map.removeLayer(currentOverlayLayer);
      }
      
      // Configurar camada base
      if (currentLayerType === 'satellite') {
        map.removeLayer(osmLayer);
        satelliteLayer.addTo(map);
        satelliteLayer.setOpacity(parseFloat(opacitySel.value || '0.8'));
      } else if (currentLayerType === 'precipitation') {
        map.removeLayer(satelliteLayer);
        osmLayer.addTo(map);
        
        // Para a camada de precipitação, precisamos da data
        if (!timeInput.value) return;
        
        const localDate = new Date(timeInput.value);
        // Converter para UTC (adicionando o offset do fuso horário)
        const utcDate = new Date(localDate.getTime() + localDate.getTimezoneOffset() * 60000);
        const roundedDate = roundTo30UTC(utcDate);
        const isoZ = toIsoZ(roundedDate);
        
        // Criar nova camada
        currentOverlayLayer = L.tileLayer(gibsUrl(isoZ), { 
          tileSize: 256, 
          opacity: parseFloat(opacitySel.value || '0.7'), 
          attribution: 'NASA GIBS / IMERG (Precipitação)',
          minZoom: 1,
          maxZoom: 9,
          errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='
        });
        
        currentOverlayLayer.addTo(map);
      }
    }

    // Inicializar a camada
    refreshLayer();
    
    // Event listeners para controles de camada
    layerControls.forEach(control => {
      control.addEventListener('change', (e) => {
        currentLayerType = e.target.value;
        refreshLayer();
        
        // Atualizar interface baseado na seleção
        if (currentLayerType === 'precipitation') {
          timeInput.disabled = false;
          btnNow.disabled = false;
        } else {
          timeInput.disabled = true;
          btnNow.disabled = true;
        }
      });
    });
    
    // Event listeners para opacidade e tempo
    opacitySel.addEventListener('change', () => {
      if (currentLayerType === 'satellite' && satelliteLayer) {
        satelliteLayer.setOpacity(parseFloat(opacitySel.value));
      } else if (currentLayerType === 'precipitation' && currentOverlayLayer) {
        currentOverlayLayer.setOpacity(parseFloat(opacitySel.value));
      }
    });
    
    btnNow.addEventListener('click', () => { 
      timeNowUTC = roundTo30UTC(new Date()); 
      setTimeInput(timeNowUTC); 
      if (currentLayerType === 'precipitation') {
        refreshLayer();
      }
    });
    
    timeInput.addEventListener('change', () => {
      if (currentLayerType === 'precipitation') {
        refreshLayer();
      }
    });

    // ===== Uber-style GPS marker =====
    const dotHTML = '<div class="uber-dot"><div class="core"></div><div class="pulse"></div></div>';
    const dotIcon = L.divIcon({ 
      html: dotHTML, 
      className: '', 
      iconSize: [16, 16], 
      iconAnchor: [8, 8] 
    });
    
    const gpsMarker = L.marker([current.lat, current.lon], { 
      icon: dotIcon, 
      interactive: false,
      zIndexOffset: 1000
    }).addTo(map);
    
    const accCircle = L.circle([current.lat, current.lon], { 
      radius: 40, 
      color: '#60a5fa', 
      weight: 1, 
      fill: true, 
      fillOpacity: 0.1,
      fillColor: '#3b82f6'
    }).addTo(map);

    function moveGPS(lat, lon, acc) {
      current = { lat, lon };
      gpsMarker.setLatLng([lat, lon]);
      accCircle.setLatLng([lat, lon]);
      if (typeof acc === 'number' && isFinite(acc)) {
        accCircle.setRadius(Math.max(10, acc));
      }
    }

    // ===== Função para atualizar o fundo baseado nas condições =====
    function updateBackground(weatherCode, isDay) {
      const body = document.body;
      body.className = ''; // Remove todas as classes anteriores
      
      // Determinar se é noite (com base na hora local)
      const now = new Date();
      const hour = now.getHours();
      const isNight = hour < 6 || hour > 18;
      
      // Se for noite, usar tema noturno independente do tempo
      if (isNight) {
        body.classList.add('night');
        return;
      }
      
      // Caso contrário, usar tema baseado no código do tempo
      if (weatherCode === 0 || weatherCode === 1) {
        // Céu limpo ou principalmente limpo
        body.classList.add('sunny');
      } else if (weatherCode >= 2 && weatherCode <= 3) {
        // Parcialmente nublado ou nublado
        body.classList.add('cloudy');
      } else if (weatherCode >= 51 || weatherCode === 45 || weatherCode === 48) {
        // Chuvisco ou nevoeiro
        body.classList.add('cloudy');
      } else if (weatherCode >= 61 || weatherCode >= 80) {
        // Chuva ou pancadas de chuva
        body.classList.add('rainy');
      } else {
        // Padrão (nublado)
        body.classList.add('cloudy');
      }
    }

    // ===== Forecast (Open‑Meteo) =====
    let chart = null;
    
    async function loadForecast() {
      try {
        alertMsg.textContent = 'Carregando dados meteorológicos...';
        alertMsg.classList.remove('ok', 'bad', 'warn');
        currentCondition.textContent = 'Carregando...';
        
        const url = new URL('https://api.open-meteo.com/v1/forecast');
        url.search = new URLSearchParams({ 
          latitude: current.lat, 
          longitude: current.lon, 
          hourly: 'temperature_2m,relativehumidity_2m,precipitation,precipitation_probability,rain,showers,weathercode', 
          daily: 'temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_hours,weathercode', 
          timezone: 'America/Sao_Paulo',
          forecast_days: 3
        }).toString();
        
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const data = await res.json(); 
        if (!data?.hourly) throw new Error('Dados inválidos da API');
        
        const H = data.hourly;
        const now = new Date();
        const timezoneOffset = now.getTimezoneOffset() * 60000;
        const localTime = new Date(now.getTime() - timezoneOffset);
        
        // Encontrar índice da hora atual
        let nowIdx = 0;
        for (let i = 0; i < H.time.length; i++) {
          const hourTime = new Date(H.time[i]);
          if (hourTime >= localTime) {
            nowIdx = i;
            break;
          }
        }
        
        // Atualizar condições atuais
        const temp = H.temperature_2m?.[nowIdx] ?? 0;
        const humidity = H.relativehumidity_2m?.[nowIdx] ?? 0;
        const weatherCode = H.weathercode?.[nowIdx] ?? 0;
        
        currentTemp.textContent = `${Math.round(temp)}°C`;
        currentCondition.textContent = getWeatherDescription(weatherCode);
        humidityValue.textContent = `${Math.round(humidity)}%`;
        humidityBar.style.width = `${humidity}%`;
        
        // Atualizar o fundo baseado nas condições
        updateBackground(weatherCode, true);
        
        const prob = H.precipitation_probability?.[nowIdx] ?? 0;
        const rain = (H.rain?.[nowIdx] ?? 0) + (H.showers?.[nowIdx] ?? 0);
        const todaySum = data.daily?.precipitation_sum?.[0] ?? null;
        
        $('kProb').textContent = prob + '%';
        $('kRain').textContent = rain.toFixed(1) + ' mm';
        $('kSum').textContent = (todaySum != null ? todaySum.toFixed(1) : '--') + ' mm';
        
        // Calcular alerta para próximas 3 horas
        let maxProb = 0, sumRain = 0;
        for (let i = nowIdx; i < nowIdx + 3 && i < H.precipitation_probability.length; i++) {
          maxProb = Math.max(maxProb, H.precipitation_probability?.[i] ?? 0);
          sumRain += (H.rain?.[i] ?? 0) + (H.showers?.[i] ?? 0);
        }
        
        let alertText = '';
        let alertClass = 'ok';
        
        if (maxProb >= 80 && sumRain >= 10) {
          alertClass = 'bad';
          alertText = `Chuva forte provável nas próximas 3h (prob. ${maxProb}%, ~${sumRain.toFixed(1)} mm).`;
        } else if (maxProb >= 60 && sumRain >= 3) {
          alertClass = 'warn';
          alertText = `Chuva moderada possível nas próximas 3h (prob. ${maxProb}%, ~${sumRain.toFixed(1)} mm).`;
        } else if (maxProb >= 30) {
          alertClass = 'ok';
          alertText = `Possibilidade de chuva fraca (prob. ${maxProb}%).`;
        } else {
          alertClass = 'ok';
          alertText = 'Sem sinal relevante de chuva nas próximas horas.';
        }
        
        alertMsg.textContent = alertText;
        alertMsg.className = 'alert ' + alertClass;
        
        // Gráfico para próximas 48 horas
        const endIdx = Math.min(nowIdx + 48, H.time.length);
        const labels = H.time.slice(nowIdx, endIdx).map(t => {
          const date = new Date(t);
          return date.toLocaleString('pt-BR', { 
            hour: '2-digit', 
            day: '2-digit', 
            month: '2-digit' 
          });
        });
        
        const mm = H.precipitation.slice(nowIdx, endIdx);
        const prob48 = H.precipitation_probability.slice(nowIdx, endIdx);
        
        const ctx = document.getElementById('chart').getContext('2d');
        if (chart) chart.destroy();
        
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                type: 'bar',
                label: 'Chuva (mm)',
                data: mm,
                yAxisID: 'y',
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
              },
              {
                type: 'line',
                label: 'Probabilidade (%)',
                data: prob48,
                yAxisID: 'y1',
                borderColor: 'rgba(239, 68, 68, 1)',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                borderWidth: 2,
                pointRadius: 2,
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: {
              y: {
                beginAtZero: true,
                position: 'left',
                title: { display: true, text: 'mm' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                grid: { drawOnChartArea: false },
                title: { display: true, text: '%' },
                suggestedMax: 100,
                ticks: { color: 'rgba(239, 68, 68, 1)' }
              },
              x: {
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                ticks: { maxTicksLimit: 12 }
            }
            },
            plugins: {
              legend: { display: true, labels: { color: '#e5ecf5' } },
              tooltip: { mode: 'index', intersect: false }
            }
          }
        });
        
      } catch (e) {
        console.warn('Forecast error', e);
        alertMsg.textContent = 'Erro ao carregar previsão. Tentando novamente em 30 segundos.';
        alertMsg.classList.remove('ok', 'bad', 'warn');
        
        $('kProb').textContent = '--%';
        $('kRain').textContent = '-- mm';
        $('kSum').textContent = '-- mm';
        currentTemp.textContent = '--°C';
        currentCondition.textContent = 'Dados indisponíveis';
        humidityValue.textContent = '--%';
        humidityBar.style.width = '0%';
        
        // Tentar novamente após 30 segundos
        setTimeout(loadForecast, 30000);
      }
    }
    
    // Função para obter descrição do tempo baseada no código meteorológico
    function getWeatherDescription(code) {
      const weatherCodes = {
        0: 'Céu limpo',
        1: 'Principalmente limpo',
        2: 'Parcialmente nublado',
        3: 'Nublado',
        45: 'Nevoeiro',
        48: 'Nevoeiro com geada',
        51: 'Chuvisco leve',
        53: 'Chuvisco moderado',
        55: 'Chuvisco denso',
        56: 'Chuvisco congelante leve',
        57: 'Chuvisco congelante denso',
        61: 'Chuva leve',
        63: 'Chuva moderada',
        65: 'Chuva forte',
        66: 'Chuva congelante leve',
        67: 'Chuva congelante forte',
        71: 'Queda de neve leve',
        73: 'Queda de neve moderada',
        75: 'Queda de neve forte',
        77: 'Grãos de neve',
        80: 'Pancadas de chuva leves',
        81: 'Pancadas de chuva moderadas',
        82: 'Pancadas de chuva violentas',
        85: 'Pancadas de neve leves',
        86: 'Pancadas de neve fortes',
        95: 'Trovoada',
        96: 'Trovoada com granizo leve',
        99: 'Trovoada com granizo forte'
      };
      
      return weatherCodes[code] || 'Condições desconhecidas';
    }

    // ===== Controls =====
    btnZN.addEventListener('click', () => {
      map.setView([ZONA_NORTE.lat, ZONA_NORTE.lon], ZONA_NORTE.zoom);
      current = { lat: ZONA_NORTE.lat, lon: ZONA_NORTE.lon };
      moveGPS(current.lat, current.lon, 40);
      loadForecast();
    });
    
    btnHere.addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocalização não suportada.');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        p => {
          const { latitude, longitude, accuracy } = p.coords;
          moveGPS(latitude, longitude, accuracy);
          map.setView([latitude, longitude], 15);
          loadForecast();
        },
        () => {
          alert('Não foi possível obter sua localização.');
          gpsStatus.textContent = 'Erro ao obter localização';
        }
      );
    });

    let following = false;
    let watchId = null;
    let lastUpdate = 0;
    
    function startFollow() {
      if (!navigator.geolocation) {
        alert('Geolocalização não suportada.');
        return;
      }
      
      if (watchId !== null) return;
      
      following = true;
      btnFollow.textContent = '📡 Seguir GPS: ON';
      btnFollow.classList.add('on');
      gpsStatus.textContent = 'Ativo';
      
      watchId = navigator.geolocation.watchPosition(
        p => {
          const { latitude, longitude, accuracy } = p.coords;
          moveGPS(latitude, longitude, accuracy);
          
          const now = Date.now();
          if (now - lastUpdate > 1000) {
            map.setView([latitude, longitude], Math.max(map.getZoom(), 15), { animate: false });
            lastUpdate = now;
          }
          
          loadForecast();
        },
        e => {
          gpsStatus.textContent = 'GPS indisponível';
          console.warn('GPS error:', e);
        },
        { enableHighAccuracy: true, maximumAge: 8000, timeout: 15000 }
      );
    }
    
    function stopFollow() {
      following = false;
      btnFollow.textContent = '📡 Seguir GPS: OFF';
      btnFollow.classList.remove('on');
      gpsStatus.textContent = '';
      
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
    }
    
    btnFollow.addEventListener('click', () => {
      following ? stopFollow() : startFollow();
    });

    // Inicializar previsão
    loadForecast();
    
    // Atualizar previsão a cada 10 minutos
    setInterval(loadForecast, 600000);

    // Desabilitar controles de tempo quando não na camada de precipitação
    timeInput.disabled = true;
    btnNow.disabled = true;
  });
</script>
</body>
</html>
