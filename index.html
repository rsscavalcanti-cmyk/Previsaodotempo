<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Previsão do Tempo Renato Stofel</title>
  <meta name="description" content="Previsão do tempo com gráfico de 15 dias e alertas de chuva" />
  <meta name="theme-color" content="#0b2a4a" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f0f8ff; --ink:#2c3e50; --muted:#7f8c8d; --card:#ffffff; --head:#3498db;
      --accent:#3498db; --ok:#27ae60; --warn:#f39c12; --bad:#e74c3c; --hair:#bdc3c7;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: 'Open Sans', sans-serif;
      color:var(--ink); 
      background:var(--bg); 
      transition: background 1.5s ease;
      line-height: 1.6;
    }
    
    /* Backgrounds dinâmicos baseados no tempo */
    body.sunny{background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%)}
    body.cloudy{background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%)}
    body.rainy{background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%)}
    body.night{background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%)}
    body.stormy{background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)}
    
    .app{
      display:grid; 
      grid-template-columns: 1fr; 
      grid-template-rows: auto 1fr auto; 
      min-height:100vh;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }
    
    header{
      padding:20px 0; 
      background:rgba(255, 255, 255, 0.9); 
      border-bottom:1px solid var(--hair); 
      display:flex; 
      flex-wrap: wrap; 
      gap:15px; 
      align-items:center; 
      justify-content:space-between;
      backdrop-filter: blur(10px);
      border-radius: 0 0 15px 15px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    header .title{display:flex; gap:15px; align-items:center}
    header h1{
      font-size:24px; 
      margin:0; 
      font-weight:700;
      font-family: 'Poppins', sans-serif;
      color: var(--head);
    }
    header .sub{
      font-size:14px; 
      color:var(--muted);
      font-weight: 300;
    }
    
    .panel{
      display:grid; 
      gap:20px; 
      padding:20px; 
      background:rgba(255, 255, 255, 0.85); 
      backdrop-filter: blur(10px);
      border-radius: 15px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    .cards{display:grid; grid-template-columns: 1fr; gap:20px}
    
    @media (min-width:980px){
      .app{grid-template-columns: 1fr; grid-template-rows: auto 1fr auto}
      .panel{grid-column:1/-1; grid-row:2/3}
      header{grid-column:1/-1}
      .cards{grid-template-columns: repeat(2, minmax(0,1fr))}
    }
    
    .card{
      background:rgba(255, 255, 255, 0.95); 
      border:1px solid var(--hair); 
      border-radius:15px; 
      padding:20px; 
      backdrop-filter: blur(5px);
      box-shadow: var(--shadow);
      transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .card h3{
      margin:0 0 15px 0; 
      font-size:18px; 
      color:var(--accent);
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      border-bottom: 2px solid var(--accent);
      padding-bottom: 8px;
    }
    
    .kpis{
      display:grid; 
      grid-template-columns: repeat(3,1fr); 
      gap:15px;
      margin-top: 15px;
    }
    .kpi{
      background:rgba(240, 248, 255, 0.8); 
      border:1px solid var(--hair); 
      border-radius:12px; 
      padding:15px; 
      text-align:center;
      transition: all 0.3s ease;
    }
    .kpi:hover {
      background: rgba(240, 248, 255, 1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .kpi .v{
      font-size:24px; 
      font-weight:700; 
      margin-bottom:5px;
      font-family: 'Poppins', sans-serif;
      color: var(--head);
    }
    .kpi .l{
      font-size:14px; 
      color:var(--muted);
      font-weight: 500;
    }
    
    .toolbar{
      display:flex; 
      flex-wrap:wrap; 
      gap:10px; 
      align-items:center;
    }
    button, select, input[type="datetime-local"]{
      background:rgba(255, 255, 255, 0.9); 
      color:var(--ink); 
      border:1px solid var(--hair); 
      border-radius:10px; 
      padding:10px 15px; 
      font-size:14px; 
      cursor:pointer;
      font-family: 'Open Sans', sans-serif;
      transition: all 0.3s ease;
    }
    button:hover, select:hover{
      outline:1px solid var(--accent); 
      background:rgba(255, 255, 255, 1);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .small{
      font-size:12px; 
      color:var(--muted);
    }
    footer{
      padding:15px; 
      border-top:1px solid var(--hair); 
      background:rgba(255, 255, 255, 0.9); 
      font-size:12px; 
      color:var(--muted); 
      text-align:center; 
      backdrop-filter: blur(10px);
      border-radius: 15px 15px 0 0;
      box-shadow: var(--shadow);
    }
    a{
      color:var(--accent); 
      text-decoration:none;
      font-weight: 600;
    }
    a:hover{
      text-decoration:underline;
    }
    
    button.on{
      outline:1px solid var(--accent); 
      border-color: var(--accent); 
      background:rgba(52, 152, 219, 0.1);
    }

    /* Alert styles */
    .alert{
      padding:12px 15px; 
      border-radius:10px; 
      font-size:14px; 
      transition:all 0.3s ease; 
      margin-top:10px;
      font-weight: 500;
    }
    .alert.ok{
      background:rgba(39, 174, 96, 0.1); 
      border-left:4px solid var(--ok);
      color: var(--ok);
    }
    .alert.bad{
      background:rgba(231, 76, 60, 0.1); 
      border-left:4px solid var(--bad);
      color: var(--bad);
    }
    .alert.warn{
      background:rgba(243, 156, 18, 0.1); 
      border-left:4px solid var(--warn);
      color: var(--warn);
    }
    
    /* Loading indicator */
    .loading{
      display:inline-block; 
      width:16px; 
      height:16px; 
      border:2px solid transparent; 
      border-top:2px solid var(--accent); 
      border-radius:50%; 
      animation:spin 1s linear infinite;
    }
    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }

    /* Current conditions */
    .current-conditions {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .temp {
      font-size: 36px;
      font-weight: 700;
      font-family: 'Poppins', sans-serif;
      color: var(--head);
    }
    
    .condition {
      font-size: 16px;
      color: var(--muted);
      font-weight: 500;
    }
    
    /* Humidity indicator */
    .humidity {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 14px;
      color: var(--muted);
    }
    
    .humidity-bar {
      flex-grow: 1;
      height: 6px;
      background: rgba(189, 195, 199, 0.3);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .humidity-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    
    /* Weather icon */
    .weather-icon {
      font-size: 36px;
      margin-right: 10px;
    }
    
    /* GPS Status */
    .gps-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 500;
    }
    
    .gps-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: var(--ok);
      animation: pulse 2s infinite;
    }
    
    .gps-dot.searching {
      background-color: var(--warn);
    }
    
    .gps-dot.error {
      background-color: var(--bad);
    }
    
    /* Peak rain info */
    .peak-rain {
      background: linear-gradient(135deg, #3498db, #2c3e50);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .peak-rain h4 {
      margin: 0 0 10px 0;
      font-size: 16px;
      font-weight: 600;
    }
    
    .peak-rain .time {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .peak-rain .prob {
      font-size: 16px;
      opacity: 0.9;
    }
    
    /* Chart container */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    /* Responsive improvements for mobile */
    @media (max-width:768px){
      .app{grid-template-rows: auto 1fr auto}
      .cards{grid-template-columns: 1fr}
      .toolbar{flex-direction:column; align-items:stretch}
      .toolbar > *{flex:1}
      header .title h1{font-size:20px}
      header .sub{font-size:13px}
      .kpis{grid-template-columns: repeat(3,1fr)}
      .kpi .v{font-size:20px}
      .kpi .l{font-size:12px}
      .current-conditions {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .temp {
        font-size: 28px;
      }
    }
    
    @media (max-width:480px){
      header{padding:15px}
      .panel{padding:15px}
      .card{padding:15px}
      .kpis{grid-template-columns: 1fr; gap:10px}
      .kpi{padding:12px}
      .toolbar button, .toolbar select, .toolbar input[type="datetime-local"]{
        padding:10px 12px; font-size:13px
      }
      .temp { font-size: 24px; }
      .weather-icon { font-size: 28px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="cloudy">
  <div class="app">
    <header>
      <div class="title">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2a7 7 0 00-7 7v1.126A4 4 0 004 14a4 4 0 004 4h8a4 4 0 002-7.53V9a7 7 0 00-6-6.93z" stroke="currentColor" stroke-width="1.4"/>
          <path d="M7 18l-1.2 2M11 18l-1.2 2M15 18l-1.2 2M19 18l-1.2 2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
        </svg>
        <div>
          <h1>Previsão do Tempo Renato Stofel</h1>
          <div class="sub">Previsão de chuva para 15 dias • Alertas meteorológicos</div>
        </div>
      </div>
      <div class="toolbar">
        <div class="gps-indicator">
          <div class="gps-dot searching" id="gpsDot"></div>
          <span id="gpsStatus">Buscando localização...</span>
        </div>
        <button id="btnZN">🗺️ Zona Norte RJ</button>
      </div>
    </header>

    <section class="panel">
      <div class="cards">
        <div class="card">
          <h3>🌡️ Condições Atuais</h3>
          <div class="current-conditions">
            <span class="weather-icon" id="weatherIcon">☀️</span>
            <div>
              <div class="temp" id="currentTemp">--°C</div>
              <div class="condition" id="currentCondition">Carregando...</div>
            </div>
          </div>
          <div class="humidity">
            <span>Umidade:</span>
            <div class="humidity-bar">
              <div class="humidity-fill" id="humidityBar" style="width: 0%"></div>
            </div>
            <span id="humidityValue">--%</span>
          </div>
          <div class="kpis">
            <div class="kpi"><div class="v" id="kProb">--%</div><div class="l">Prob. de chuva</div></div>
            <div class="kpi"><div class="v" id="kRain">-- mm</div><div class="l">Chuva (1h)</div></div>
            <div class="kpi"><div class="v" id="kSum">-- mm</div><div class="l">Acumulado hoje</div></div>
          </div>
        </div>
        
        <div class="card" id="alertBox">
          <h3>⚠️ Alerta Rápido (próximas 3h)</h3>
          <div class="alert" id="alertMsg">Carregando condições meteorológicas...</div>
        </div>
        
        <div class="card">
          <h3>📊 Previsão de Chuva para 15 Dias</h3>
          <div class="chart-container">
            <canvas id="chart"></canvas>
          </div>
        </div>
        
        <div class="card">
          <h3>⏰ Maior Probabilidade de Chuva</h3>
          <div class="peak-rain">
            <h4>Período com maior chance de chuva:</h4>
            <div class="time" id="peakTime">--</div>
            <div class="prob" id="peakProb">Probabilidade: --%</div>
          </div>
        </div>
      </div>
      
      <div class="small" style="margin-top:15px; text-align:center">
        Dados de previsão: <a href="https://open-meteo.com/" target="_blank" rel="noopener">Open-Meteo</a>
      </div>
    </section>

    <footer>
      Atualizado automaticamente • GPS ativo para acompanhar sua localização em tempo real
    </footer>
  </div>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    // ===== Utils =====
    const $ = (id) => document.getElementById(id);
    const gpsStatus = $('gpsStatus');
    const gpsDot = $('gpsDot');
    const btnZN = $('btnZN');
    const alertMsg = $('alertMsg');
    const currentTemp = $('currentTemp');
    const currentCondition = $('currentCondition');
    const humidityValue = $('humidityValue');
    const humidityBar = $('humidityBar');
    const weatherIcon = $('weatherIcon');
    const peakTime = $('peakTime');
    const peakProb = $('peakProb');

    // ===== Config =====
    const ZONA_NORTE = { lat: -22.86, lon: -43.28 };
    let current = { lat: ZONA_NORTE.lat, lon: ZONA_NORTE.lon };
    let watchId = null;

    // ===== Função para atualizar o fundo baseado nas condições =====
    function updateBackground(weatherCode) {
      const body = document.body;
      body.className = ''; // Remove todas as classes anteriores
      
      // Determinar se é noite (com base na hora local)
      const now = new Date();
      const hour = now.getHours();
      const isNight = hour < 6 || hour > 18;
      
      // Se for noite, usar tema noturno independente do tempo
      if (isNight) {
        body.classList.add('night');
        return;
      }
      
      // Caso contrário, usar tema baseado no código do tempo
      if (weatherCode === 0 || weatherCode === 1) {
        // Céu limpo ou principalmente limpo
        body.classList.add('sunny');
      } else if (weatherCode >= 2 && weatherCode <= 3) {
        // Parcialmente nublado ou nublado
        body.classList.add('cloudy');
      } else if (weatherCode >= 51 || weatherCode === 45 || weatherCode === 48) {
        // Chuvisco ou nevoeiro
        body.classList.add('cloudy');
      } else if (weatherCode >= 61 || weatherCode >= 80) {
        // Chuva ou pancadas de chuva
        body.classList.add('rainy');
      } else if (weatherCode >= 95) {
        // Tempestade
        body.classList.add('stormy');
      } else {
        // Padrão (nublado)
        body.classList.add('cloudy');
      }
    }

    // ===== Função para obter ícone baseado no código meteorológico =====
    function getWeatherIcon(code) {
      const weatherIcons = {
        0: '☀️', // Céu limpo
        1: '🌤️', // Principalmente limpo
        2: '⛅', // Parcialmente nublado
        3: '☁️', // Nublado
        45: '🌫️', // Nevoeiro
        48: '🌫️', // Nevoeiro com geada
        51: '🌦️', // Chuvisco leve
        53: '🌦️', // Chuvisco moderado
        55: '🌦️', // Chuvisco denso
        56: '🌧️', // Chuvisco congelante leve
        57: '🌧️', // Chuvisco congelante denso
        61: '🌧️', // Chuva leve
        63: '🌧️', // Chuva moderada
        65: '⛈️', // Chuva forte
        66: '🌧️', // Chuva congelante leve
        67: '🌧️', // Chuva congelante forte
        71: '🌨️', // Queda de neve leve
        73: '🌨️', // Queda de neve moderada
        75: '🌨️', // Queda de neve forte
        77: '🌨️', // Grãos de neve
        80: '🌦️', // Pancadas de chuva leves
        81: '⛈️', // Pancadas de chuva moderadas
        82: '⛈️', // Pancadas de chuva violentas
        85: '🌨️', // Pancadas de neve leves
        86: '🌨️', // Pancadas de neve fortes
        95: '⛈️', // Trovoada
        96: '⛈️', // Trovoada com granizo leve
        99: '⛈️'  // Trovoada com granizo forte
      };
      
      return weatherIcons[code] || '🌤️';
    }

    // ===== Forecast (Open‑Meteo) =====
    let chart = null;
    
    async function loadForecast() {
      try {
        alertMsg.textContent = 'Carregando dados meteorológicos...';
        alertMsg.classList.remove('ok', 'bad', 'warn');
        currentCondition.textContent = 'Carregando...';
        
        const url = new URL('https://api.open-meteo.com/v1/forecast');
        url.search = new URLSearchParams({ 
          latitude: current.lat, 
          longitude: current.lon, 
          hourly: 'temperature_2m,relativehumidity_2m,precipitation,precipitation_probability,rain,showers,weathercode', 
          daily: 'temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_hours,weathercode', 
          timezone: 'America/Sao_Paulo',
          forecast_days: 16 // 15 dias + hoje
        }).toString();
        
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const data = await res.json(); 
        if (!data?.hourly) throw new Error('Dados inválidos da API');
        
        const H = data.hourly;
        const now = new Date();
        const timezoneOffset = now.getTimezoneOffset() * 60000;
        const localTime = new Date(now.getTime() - timezoneOffset);
        
        // Encontrar índice da hora atual
        let nowIdx = 0;
        for (let i = 0; i < H.time.length; i++) {
          const hourTime = new Date(H.time[i]);
          if (hourTime >= localTime) {
            nowIdx = i;
            break;
          }
        }
        
        // Atualizar condições atuais
        const temp = H.temperature_2m?.[nowIdx] ?? 0;
        const humidity = H.relativehumidity_2m?.[nowIdx] ?? 0;
        const weatherCode = H.weathercode?.[nowIdx] ?? 0;
        
        currentTemp.textContent = `${Math.round(temp)}°C`;
        currentCondition.textContent = getWeatherDescription(weatherCode);
        humidityValue.textContent = `${Math.round(humidity)}%`;
        humidityBar.style.width = `${humidity}%`;
        
        // Atualizar o ícone do tempo
        weatherIcon.textContent = getWeatherIcon(weatherCode);
        
        // Atualizar o fundo baseado nas condições
        updateBackground(weatherCode);
        
        const prob = H.precipitation_probability?.[nowIdx] ?? 0;
        const rain = (H.rain?.[nowIdx] ?? 0) + (H.showers?.[nowIdx] ?? 0);
        const todaySum = data.daily?.precipitation_sum?.[0] ?? null;
        
        $('kProb').textContent = prob + '%';
        $('kRain').textContent = rain.toFixed(1) + ' mm';
        $('kSum').textContent = (todaySum != null ? todaySum.toFixed(1) : '--') + ' mm';
        
        // Calcular alerta para próximas 3 horas
        let maxProb = 0, sumRain = 0;
        for (let i = nowIdx; i < nowIdx + 3 && i < H.precipitation_probability.length; i++) {
          maxProb = Math.max(maxProb, H.precipitation_probability?.[i] ?? 0);
          sumRain += (H.rain?.[i] ?? 0) + (H.showers?.[i] ?? 0);
        }
        
        let alertText = '';
        let alertClass = 'ok';
        
        if (maxProb >= 80 && sumRain >= 10) {
          alertClass = 'bad';
          alertText = `Chuva forte provável nas próximas 3h (prob. ${maxProb}%, ~${sumRain.toFixed(1)} mm).`;
        } else if (maxProb >= 60 && sumRain >= 3) {
          alertClass = 'warn';
          alertText = `Chuva moderada possível nas próximas 3h (prob. ${maxProb}%, ~${sumRain.toFixed(1)} mm).`;
        } else if (maxProb >= 30) {
          alertClass = 'ok';
          alertText = `Possibilidade de chuva fraca (prob. ${maxProb}%).`;
        } else {
          alertClass = 'ok';
          alertText = 'Sem sinal relevante de chuva nas próximas horas.';
        }
        
        alertMsg.textContent = alertText;
        alertMsg.className = 'alert ' + alertClass;
        
        // Encontrar pico de chuva nos próximos 15 dias
        let peakIndex = nowIdx;
        let peakProbability = 0;
        
        // Verificar apenas as próximas 360 horas (15 dias)
        const maxHours = Math.min(nowIdx + 360, H.precipitation_probability.length);
        for (let i = nowIdx; i < maxHours; i++) {
          if (H.precipitation_probability[i] > peakProbability) {
            peakProbability = H.precipitation_probability[i];
            peakIndex = i;
          }
        }
        
        // Formatar data/hora do pico de chuva
        const peakDate = new Date(H.time[peakIndex]);
        const formattedDate = peakDate.toLocaleDateString('pt-BR', { 
          weekday: 'long', 
          day: 'numeric', 
          month: 'long',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        peakTime.textContent = formattedDate;
        peakProb.textContent = `Probabilidade: ${peakProbability}%`;
        
        // Gráfico para próximos 15 dias (dados diários)
        const dailyData = data.daily;
        const daysToShow = 15;
        
        const labels = [];
        const precipitationData = [];
        const probabilityData = [];
        
        for (let i = 0; i < daysToShow && i < dailyData.time.length; i++) {
          const date = new Date(dailyData.time[i]);
          labels.push(date.toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric', month: 'short' }));
          precipitationData.push(dailyData.precipitation_sum[i] || 0);
          probabilityData.push(dailyData.precipitation_hours[i] ? 
            Math.min(100, dailyData.precipitation_hours[i] * 6.25) : 0); // Aproximação baseada em horas de chuva
        }
        
        const ctx = document.getElementById('chart').getContext('2d');
        if (chart) chart.destroy();
        
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                type: 'bar',
                label: 'Chuva (mm)',
                data: precipitationData,
                yAxisID: 'y',
                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                borderColor: 'rgba(52, 152, 219, 1)',
                borderWidth: 1
              },
              {
                type: 'line',
                label: 'Probabilidade (%)',
                data: probabilityData,
                yAxisID: 'y1',
                borderColor: 'rgba(231, 76, 60, 1)',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                borderWidth: 2,
                pointRadius: 3,
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
              y: {
                beginAtZero: true,
                position: 'left',
                title: { display: true, text: 'mm' },
                grid: { color: 'rgba(0, 0, 0, 0.1)' }
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                grid: { drawOnChartArea: false },
                title: { display: true, text: '%' },
                suggestedMax: 100,
                ticks: { color: 'rgba(231, 76, 60, 1)' }
              },
              x: {
                grid: { color: 'rgba(0, 0, 0, 0.1)' }
              }
            },
            plugins: {
              legend: { 
                display: true, 
                labels: { 
                  color: '#2c3e50',
                  font: {
                    family: "'Open Sans', sans-serif",
                    size: 12
                  }
                } 
              },
              tooltip: { 
                mode: 'index', 
                intersect: false,
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                titleColor: '#2c3e50',
                bodyColor: '#2c3e50',
                borderColor: '#bdc3c7',
                borderWidth: 1
              }
            }
          }
        });
        
      } catch (e) {
        console.warn('Forecast error', e);
        alertMsg.textContent = 'Erro ao carregar previsão. Tentando novamente em 30 segundos.';
        alertMsg.classList.remove('ok', 'bad', 'warn');
        
        $('kProb').textContent = '--%';
        $('kRain').textContent = '-- mm';
        $('kSum').textContent = '-- mm';
        currentTemp.textContent = '--°C';
        currentCondition.textContent = 'Dados indisponíveis';
        humidityValue.textContent = '--%';
        humidityBar.style.width = '0%';
        weatherIcon.textContent = '❓';
        peakTime.textContent = '--';
        peakProb.textContent = 'Probabilidade: --%';
        
        // Tentar novamente após 30 segundos
        setTimeout(loadForecast, 30000);
      }
    }
    
    // Função para obter descrição do tempo baseada no código meteorológico
    function getWeatherDescription(code) {
      const weatherCodes = {
        0: 'Céu limpo',
        1: 'Principalmente limpo',
        2: 'Parcialmente nublado',
        3: 'Nublado',
        45: 'Nevoeiro',
        48: 'Nevoeiro com geada',
        51: 'Chuvisco leve',
        53: 'Chuvisco moderado',
        55: 'Chuvisco denso',
        56: 'Chuvisco congelante leve',
        57: 'Chuvisco congelante denso',
        61: 'Chuva leve',
        63: 'Chuva moderada',
        65: 'Chuva forte',
        66: 'Chuva congelante leve',
        67: 'Chuva congelante forte',
        71: 'Queda de neve leve',
        73: 'Queda de neve moderada',
        75: 'Queda de neve forte',
        77: 'Grãos de neve',
        80: 'Pancadas de chuva leves',
        81: 'Pancadas de chuva moderadas',
        82: 'Pancadas de chuva violentas',
        85: 'Pancadas de neve leves',
        86: 'Pancadas de neve fortes',
        95: 'Trovoada',
        96: 'Trovoada com granizo leve',
        99: 'Trovoada com granizo forte'
      };
      
      return weatherCodes[code] || 'Condições desconhecidas';
    }

    // ===== GPS Automático =====
    function startGPS() {
      if (!navigator.geolocation) {
        gpsStatus.textContent = 'Geolocalização não suportada';
        gpsDot.className = 'gps-dot error';
        return;
      }
      
      gpsStatus.textContent = 'Buscando localização...';
      gpsDot.className = 'gps-dot searching';
      
      // Primeiro, tentar obter a localização atual
      navigator.geolocation.getCurrentPosition(
        position => {
          const { latitude, longitude, accuracy } = position.coords;
          current = { lat: latitude, lon: longitude };
          gpsStatus.textContent = 'Localização ativa';
          gpsDot.className = 'gps-dot';
          loadForecast();
        },
        error => {
          gpsStatus.textContent = 'Erro ao obter localização';
          gpsDot.className = 'gps-dot error';
          console.warn('GPS error:', error);
          // Usar localização padrão (Zona Norte RJ)
          current = { lat: ZONA_NORTE.lat, lon: ZONA_NORTE.lon };
          loadForecast();
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
      
      // Iniciar monitoramento contínuo
      watchId = navigator.geolocation.watchPosition(
        position => {
          const { latitude, longitude, accuracy } = position.coords;
          current = { lat: latitude, lon: longitude };
          gpsStatus.textContent = 'Localização ativa';
          gpsDot.className = 'gps-dot';
          loadForecast();
        },
        error => {
          gpsStatus.textContent = 'GPS indisponível';
          gpsDot.className = 'gps-dot error';
          console.warn('GPS error:', error);
        },
        { enableHighAccuracy: true, maximumAge: 8000, timeout: 15000 }
      );
    }

    // ===== Controls =====
    btnZN.addEventListener('click', () => {
      current = { lat: ZONA_NORTE.lat, lon: ZONA_NORTE.lon };
      loadForecast();
    });

    // Inicializar GPS automaticamente
    startGPS();
    
    // Atualizar previsão a cada 10 minutos
    setInterval(loadForecast, 600000);
  });
</script>
</body>
</html>

